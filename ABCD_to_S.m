%--------------------------------------------------------------------

function S = ABCD_to_S(T, Z0)
%--------------------------------------------------------------------


if nargin == 1
    Z0 = 50;
end
if length(Z0) == 1
    Z0(2) = Z0(1);
end
Z01 = Z0(1);
Z02 = Z0(2);
Zm = sqrt(Z01*Z02);

%--------------------------------------------------------------------

A = T(1, 1);
B = T(1, 2);
C = T(2, 1);
D = T(2, 2);
delta = det(T);

%--------------------------------------------------------------------

S = zeros(2, 2);

%--------------------------------------------------------------------

if Z01 == 0
    S(2, 2) = (-A*Z02 + B) / (+A*Z02 + B);
    return
end

%--------------------------------------------------------------------

if Z01 == inf
    S(2, 2) = (-D - C*Z02) / (+D + C*Z02);
    return
end

%--------------------------------------------------------------------

if Z02 == 0
    S(1, 1) = (-D*Z01 + B) / (+D*Z01 + B);
    return
end

%--------------------------------------------------------------------

if Z02 == inf
    S(1, 1) = (+A - C*Z01) / (+A + C*Z01);
    return
end

%--------------------------------------------------------------------

Den = A*Z02 + D*Z01 + B + C*Z01*Z02;
Num_11 = +A*Z02 - D*Z01 + B - C*Z01*Z02;
Num_21 = 2*Zm;
Num_12 = 2*Zm*delta;
Num_22 = -A*Z02 + D*Z01 + B - C*Z01*Z02;

%--------------------------------------------------------------------

S(1, 1) = Num_11/Den;
S(1, 2) = Num_12/Den;
S(2, 1) = Num_21/Den;
S(2, 2) = Num_22/Den;

%--------------------------------------------------------------------

if abs(C) == inf
    S = [-1, 0; 0, -1];
end

%--------------------------------------------------------------------

if abs(B) == inf
    S = [+1, 0; 0, +1];
end

%--------------------------------------------------------------------
